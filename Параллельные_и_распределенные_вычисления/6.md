```
Параллельные и распределенные вычисления.
```
**Распараллеливание циклов. Класс Parallel**

Одна из основных задач, возникающая при параллельных вычислениях, связана с
распараллеливанием циклов. При распараллеливании всей итерации цикла могут выполняться
одновременно и в произвольном порядке. Понятно, что не всякий цикл может быть
распараллелен, итерации должны быть независимыми, множество переменных, изменяемых на
каждой итерации, не должны пересекаться, дабы избежать проблем с гонкой данных,
блокировками и синхронизаций.

Проблемы при распараллеливании цикла:

1. **Накладные расходы** , когда каждая итерация цикла выполняется в отдельном потоке, то
    расходы связанные с привлечением потоков расходы памяти и времени. Если доля
    накладных расходов мала, в сравнении с выигрышем по времени, которая получается за
    счет параллельного выполнения, то ими можно пожертвовать, но для коротких циклов,
    где число операций выполняемых на каждой из итераций мало, нужно прилагать особые
    усилия для уменьшения накладных расходов.
2. **Балансировка нагрузки** , может оказаться, что некоторые итерации выполняются дольше,
    чем остальные, в этом случае необходимо предпринимать, специальные меры для
    балансировки нагрузки на используемые потоки.
3. **Управление итерациями**. При выполнении одной или нескольких итераций могут
    возникать условия, требующие завершения цикла. Причины досрочного завершения могут
    быть разными. Например: достижение требуемого результата, обнаружение ситуаций, при
    которой продолжение цикла должно быть прервано, возникновение исключительной
    ситуации, прерывающей выполнение итерации, во всех этих случаях нужно разумным
    способом завершить выполняемые итерации и не порождать выполнение итераций, еще
    не начавших свое выполнение.

Класс Parallel облегчает их решение. Находится в System.Threading.Tasks. Класс Parallel –
статический класс, у которого, только 3 метода:

1. For – параллельная версия оператора for, метод перегружен и имеет 12 реализаций.
2. ForEach – параллельная версия оператора foreach, метод перегружен и имеет 20
    реализаций.
3. Invoke – метод, позволяющий организовать распараллеливание задач. Метод имеет 2
    реализации.

**Метод Parallel.For**

Простейшая и основная форма метода Parallel.For имеет следующий синтаксис
```
public static ParallelLoopResult For(int fromInclusive, int toExclusive, Action<int> body)
```
Первые два параметра задают нижнюю и верхнюю границы области изменения индекса. Нижняя
граница включается в область, верхняя исключается. Это соответствует общепринятой записи
оператора for(int i=0; i < n; i++) { body(i); }, в данном случае параметр body это делегат класса
Action. Представляет метод, выполняющий тело цикла, методу передается индекс той итерации,
которую должен выполнить этот метод. При распараллеливании циклов на языке C#
ответственность за корректное применение метода Parallel.For полностью лежит на
программисте, если применить этот метод к циклу, где итерации не являются независимыми, то
цикл будет выполняться, итерации будут выполняться параллельно, время работы сократится, но
из-за гонки данных, скорее всего результат будет неправильным.


Пример применения Paralle.For:
```
int s = 0;

Parallel.For(0, n, (i) => {

s = s + i;

} );

Или же

int s = 0;

for (int i = 0; i < n; i++) {

s = s + i;

}
```
[< Previous](5.md) | [Next >](7.md)